<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Farm Planner — Demo</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <style>
    body { font-family: sans-serif; margin:0; background:#0b1020; color:#eaf0ff; }
    header { padding:10px; background:#121a33; }
    h1 { font-size:18px; margin:0; }
    .wrap { display:grid; grid-template-columns: 380px 1fr; gap:12px; padding:12px; }
    .card { background:#121a33; border-radius:12px; padding:12px; }
    #map { height:480px; }
    pre { background:#0f1730; padding:10px; border-radius:8px; overflow:auto; }
    label { font-size:12px; display:block; margin-top:6px; }
    input { width:100%; padding:6px; margin-bottom:6px; }
    button { padding:8px; margin-top:6px; }
    @media(max-width:960px){.wrap{grid-template-columns:1fr;}#map{height:320px}}
  </style>
</head>
<body>
  <header><h1>Farm Planner Demo</h1></header>
  <div class="wrap">
    <div class="card">
      <h2>Parcel Search</h2>
      <label>Address</label>
      <input id="addr" value="217 W Green St, Snow Hill, MD" />
      <div class="row">
        <button id="btnSearch">Search Parcel</button>
        <button id="btnQuick">Run Quick Analysis</button>
      </div>
      <pre id="parcelJson"></pre>
      <h3>Quick Analysis Result</h3>
      <h2>Economics</h2>
      <label>Workers</label><input id="workers" type="number" value="6" />
      <label>Weekly pay/worker</label><input id="pay" type="number" value="750" />
      <label>Land price</label><input id="price" type="number" value="400000" />
      <label>Down payment %</label><input id="dpct" type="number" step="0.01" />
      <label>Down payment $</label><input id="damt" type="number" step="0.01" />
      <label>Interest rate %</label><input id="rate" type="number" step="0.01" value="6.5" />
      <label>Years</label><input id="years" type="number" value="20" />
      <button id="btnEcon">Compute</button>
      <pre id="econJson"></pre>
    </div>
    <div class="card">
      <h2>Map</h2>
      <div id="map"></div>
    </div>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    const API_BASE = (location.protocol === 'file:') ? 'http://localhost:8080' : '';
    const map = L.map('map').setView([38.18,-75.39], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let parcelLayer;

    function renderGeoJSON(geo){
      if (parcelLayer) map.removeLayer(parcelLayer);
      parcelLayer = L.geoJSON(geo).addTo(map);
      try { map.fitBounds(parcelLayer.getBounds()); } catch{}
    }

    function xsrfHeaders(){
      const m=document.cookie.match(/XSRF-TOKEN=([^;]+)/);
      return m?{'X-XSRF-TOKEN':decodeURIComponent(m[1])}:{};
    }

    document.getElementById('btnSearch').onclick = async () => {
      const addr=document.getElementById('addr').value;
      const out=document.getElementById('parcelJson');
      out.textContent='Loading…';
      try{
        const controller = new AbortController();
        const t = setTimeout(()=>controller.abort(), 12000);
        const res=await fetch(`${API_BASE}/api/parcels/search`,{
          method:'POST',headers:{'Content-Type':'application/json',...xsrfHeaders()},
          credentials:'include',signal:controller.signal,body:JSON.stringify({address:addr})});
        clearTimeout(t);
        const txt=await res.text();
        out.textContent = res.ok ? txt : `HTTP ${res.status} ${res.statusText}

`+txt;
        try{const d=JSON.parse(txt);const geo=d.geometry||d.data?.geometry||(d.type==='FeatureCollection'?d:null);if(geo)renderGeoJSON(geo);}catch{}
      }catch(e){ out.textContent='Network error: '+(e.name==='AbortError'?'timeout':'')+' '+e; }
    };

    document.getElementById('btnQuick').onclick = async () => {
      const addr=document.getElementById('addr').value;
      const out=document.getElementById('parcelJson');
      out.textContent='Loading quick analysis…';
      try{
        const res=await fetch(`${API_BASE}/api/analysis/quick`,{
          method:'POST',headers:{'Content-Type':'application/json'},
          credentials:'include',body:JSON.stringify({address:addr})});
        const txt=await res.text();
        out.textContent = res.ok ? txt : `HTTP ${res.status} ${res.statusText}\n\n`+txt;
      }catch(e){ out.textContent='Error '+e; }
    };

    document.getElementById('btnEcon').onclick = async () => {
      const payload={workers:+workers.value,weeklyPayPerWorker:+pay.value,landPrice:+price.value,downPaymentPct:dpct.value?+dpct.value:null,downPaymentAmount:damt.value?+damt.value:null,annualInterestRatePct:+rate.value,years:+years.value};
      const out=document.getElementById('econJson');
      out.textContent='Loading…';
      try{
        const res=await fetch(`${API_BASE}/api/analysis/econ/assess`,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(payload)});
        out.textContent=await res.text();
      }catch(e){out.textContent='Error '+e;}
    };
  </script>
</body>
</html>
